<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dropify — Demo (single-file enabled.json + package.json + JS)</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- expose package.json as a linked resource (optional, useful for debugging/download) -->
  <link rel="alternate" type="application/json" href="package.json" />
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="logo" href="#">Dropify (Demo)</a>
      <nav class="nav">
        <a href="#shop" class="nav-link">Shop</a>
        <a href="#about" class="nav-link">About</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Dropify — Feature toggle demo</h1>
      <p id="status">Loading configuration...</p>
      <div id="app-root"></div>
    </section>

    <section id="shop" class="section">
      <h2>Products</h2>
      <div id="products" class="product-grid"></div>
    </section>
  </main>

  <footer class="site-footer container">
    <p>© <span id="year"></span> Dropify demo</p>
    <p><a href="enabled.json" download>Download enabled.json</a> • <a href="package.json" download>Download package.json</a></p>
  </footer>

  <!-- Boot script loads JSON "enabled.json" and "package.json", then conditionally imports modules -->
  <script type="module">
    // Boot loader: load configuration and package, then enable JS modules accordingly.
    async function boot() {
      const statusEl = document.getElementById('status');
      try {
        // Fetch the feature toggle file (enabled.json)
        const [enabledResp, pkgResp] = await Promise.all([
          fetch('./enabled.json', {cache: "no-store"}),
          fetch('./package.json', {cache: "no-store"})
        ]);

        if (!enabledResp.ok) throw new Error('Failed to load enabled.json');
        if (!pkgResp.ok) throw new Error('Failed to load package.json');

        const enabled = await enabledResp.json();
        const pkg = await pkgResp.json();

        // Expose to window for debugging or other scripts
        window.__DROPIFY_ENABLED__ = enabled;
        window.__DROPIFY_PACKAGE__ = pkg;

        document.getElementById('year').textContent = new Date().getFullYear();

        statusEl.textContent = 'Configuration loaded.';

        // If app is enabled, dynamically import app.js (ES module)
        if (enabled.enableApp) {
          statusEl.textContent = 'Initializing app...';
          const module = await import('./app.js');
          if (module && typeof module.initApp === 'function') {
            // pass both enabled toggles and package metadata to the module
            module.initApp({ enabled, package: pkg });
            statusEl.textContent = 'App initialized.';
          } else {
            statusEl.textContent = 'App module loaded, but initApp not found.';
          }
        } else {
          statusEl.textContent = 'App disabled by enabled.json.';
        }

        // Conditionally load optional feature script (non-module fallback)
        if (enabled.loadLegacyScript) {
          // demonstrate loading a plain JS file (script.js)
          const s = document.createElement('script');
          s.src = './script.js';
          s.defer = true;
          document.body.appendChild(s);
        }

      } catch (err) {
        statusEl.textContent = 'Error during boot: ' + err.message;
        console.error(err);
      }
    }

    boot();
  </script>
</body>
</html>
